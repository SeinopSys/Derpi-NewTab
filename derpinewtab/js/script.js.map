{"version":3,"sources":["script.js"],"names":["$","setBackgroundStyles","image_url","_currentImageURL","url","replace","styles","settings","crop","$imageGhost","css","$style","html","reQuest","page","metadata","image","cachedurl","tags","split","artists","each","i","el","indexOf","push","substring","artistText","length","textify","$data","empty","append","id","children","simplemarquee","speed","cycles","Infinity","space","handleHover","delayBetweenCycles","votestr","cc","comment_count","upvotes","downvotes","created_at","uploader","updateMetadataSettings","window","updateTimesF","fadeIt","fadeOutData","$image","$body","on","throttle","document","getElementById","$fadeLayer","this","addClass","removeClass","triggerHandler","$showSettingsButton","attr","e","preventDefault","$settingsWrap","toggleClass","movetimeout","clearTimeout","hasClass","setTimeout","hideFunction","$tagSettings","find","slideUp","ajax","filterID","everythingFilterID","allowedTags","join","success","data","imgElement","Image","search","width","height","LStorage","has","get","sha512_hash","getCachedIMGURL","src","set","error","navigator","onLine","unbindHandlers","off","list","separator","list_str","list_str_len","maxDest","splice","getJSON","text","version","undefined","$settings","$metaSettings","$cropSettings","$filterID","$filterIDSelect","$signinFilter","$usefilterInput","$optg","your","createElement","global","userpage","$filter","name","parseInt","val","tagSelectCountdownStarter","tagselectTimeout","clearInterval","tagselectCountdownInterval","tagSelectCountdown","$elem","parent","is","stop","hide","slideDown","tagArray","setInterval","$systags","$input","tag","prop","tagsCond","filterCond","isNaN","del","possibleTags","setTags","type","checked","$thisInput","prev","filterid","trigger","$this","test","currFilter","noupdatekeys","keys","$inputs","filter","last","Object","stopPropagation","nameAttr","attrIndx","updateCroppingSettings","setTo","$select","$dialog","remove","end","prependTo","material_select"],"mappings":"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","file":"script.js","sourcesContent":["/* global LStorage,updateMetadataSettings */\r\n$(function(){\r\n\t'use strict';\r\n\r\n\t$.getJSON('manifest.json',function(data){\r\n\t\tif (!data) return;\r\n\r\n\t\t$('#disp-version').text(' v'+data.version);\r\n\t});\r\n\r\n\t//Setting check\r\n\tlet settings = {\r\n\t\t\tallowedTags: [],\r\n\t\t\tmetadata: {},\r\n\t\t\tcrop: undefined,\r\n\t\t\tfilterID: undefined,\r\n\t\t},\r\n\t\teverythingFilterID = 56027,\r\n\t\t$settingsWrap = $('#settingsWrap'),\r\n\t\t$settings = $('#settings'),\r\n\t\t$tagSettings = $('#tag-settings'),\r\n\t\t$body = $('body'),\r\n\t\t$metaSettings = $('#metadata-settings'),\r\n\t\t$cropSettings = $('#crop-settings'),\r\n\t\t$image = $('#image'),\r\n\t\t$imageGhost = $('#image-ghost'),\r\n\t\t$fadeLayer = $('#fade-layer'),\r\n\t\t$data = $('#data'),\r\n\t\t$style = $('#style'),\r\n\t\t$filterID = $('#filter-id'),\r\n\t\t$filterIDSelect = $('#filter-id-select'),\r\n\t\t$signinFilter = $('#signin-filter'),\r\n\t\t$usefilterInput = $tagSettings.find('.usefilter input'),\r\n\t\t$showSettingsButton = $('#show-settings-button'),\r\n\t\t_currentImageURL;\r\n\r\n\t$.get('https://derpibooru.org/filters',function(data){\r\n\t\tlet $data = $(data.replace(/src=\"[^\"]+?\"/g,'')),\r\n\t\t\t$optg = {\r\n\t\t\t\tyour: $(document.createElement('optgroup')).attr('label','My Filters'),\r\n\t\t\t\tglobal: $(document.createElement('optgroup')).attr('label','Global Filters'),\r\n\t\t\t},\r\n\t\t\tuserpage = $data.find('.header__link.header__link-user').attr('href');\r\n\r\n\t\tif (!userpage){\r\n\t\t\t$signinFilter.addClass('nope').attr('title','You must be signed in on Derpibooru.org to see your own filters.');\r\n\t\t}\r\n\r\n\t\t$data.find('.filter').each(function(){\r\n\t\t\tlet $filter = $(this),\r\n\t\t\t\tname = $filter.children('h3').text(),\r\n\t\t\t\tid = parseInt($filter.children('.filter-options').find('a[href^=\"/filters/\"]').attr('href').replace(/\\D/g,''), 10);\r\n\r\n\t\t\tif (id === everythingFilterID)\r\n\t\t\t\treturn;\r\n\r\n\t\t\t$optg[$filter.find('a[href=\"'+userpage+'\"]').length ? 'your' : 'global'].append($(document.createElement('option')).attr('value',id).text(name));\r\n\t\t});\r\n\r\n\t\tif ($optg.your.children().length)\r\n\t\t\t$filterIDSelect.append($optg.your);\r\n\t\t$filterIDSelect.append($optg.global);\r\n\t\tif (settings.filterID){\r\n\t\t\tif ($filterIDSelect.find('option[value=\"'+settings.filterID+'\"]').length)\r\n\t\t\t\t$filterIDSelect.val(settings.filterID);\r\n\t\t\telse $filterIDSelect.val('???');\r\n\t\t}\r\n\t\telse $filterIDSelect.val('');\r\n\t});\r\n\r\n\t// Tag settings\r\n\t(function TagSettings(){\r\n\t\tlet possibleTags = ['safe','suggestive','questionable','explicit'],\r\n\t\t\ttagselectTimeout, tagselectCountdownInterval;\r\n\t\tif (LStorage.has('setting_allowed_tags')){\r\n\t\t\tlet setTags = LStorage.get('setting_allowed_tags').split(',');\r\n\t\t\t$.each(setTags,function(i,el){\r\n\t\t\t\tif (possibleTags.indexOf(el) > -1)\r\n\t\t\t\t\tsettings.allowedTags.push(el);\r\n\t\t\t});\r\n\t\t\tif (settings.allowedTags.length > 0) LStorage.set('setting_allowed_tags',settings.allowedTags.join(','));\r\n\t\t}\r\n\t\tif (settings.allowedTags.length === 0){\r\n\t\t\tLStorage.set('setting_allowed_tags','safe');\r\n\t\t\tsettings.allowedTags = ['safe'];\r\n\t\t}\r\n\t\tlet $systags = $settings.find('.systags');\r\n\t\t$.each(possibleTags,function(i,el){\r\n\t\t\t$systags.append(\r\n\t\t\t\t$(document.createElement('label')).append(\r\n\t\t\t\t\t$(document.createElement('input')).attr({\r\n\t\t\t\t\t\ttype: 'checkbox',\r\n\t\t\t\t\t\tname: el,\r\n\t\t\t\t\t\tchecked: settings.allowedTags.indexOf(el) > -1,\r\n\t\t\t\t\t}),\r\n\t\t\t\t\t'<span>'+el+'</span>'\r\n\t\t\t\t)\r\n\t\t\t);\r\n\t\t});\r\n\t\tfunction tagSelectCountdownStarter(){\r\n\t\t\tif (typeof tagselectTimeout === 'number'){\r\n\t\t\t\tclearInterval(tagselectTimeout);\r\n\t\t\t\t//noinspection JSUnusedAssignment\r\n\t\t\t\ttagselectTimeout = undefined;\r\n\t\t\t}\r\n\t\t\tif (typeof tagselectCountdownInterval === \"number\"){\r\n\t\t\t\tclearInterval(tagselectCountdownInterval);\r\n\t\t\t\ttagselectCountdownInterval = undefined;\r\n\t\t\t}\r\n\r\n\t\t\tlet i = 6,\r\n\t\t\t\ttagSelectCountdown = function(){\r\n\t\t\t\t\tif (--i === 0) return clearInterval(tagselectCountdownInterval);\r\n\r\n\t\t\t\t\tlet $elem = $tagSettings.find('.re-request span').text(i+' second'+(i !== 1 ? 's':'')).parent();\r\n\t\t\t\t\tif (!$elem.is(':visible')) $elem.stop().hide().slideDown();\r\n\t\t\t\t},\r\n\t\t\t\ttagArray = [];\r\n\r\n\t\t\ttagselectCountdownInterval = setInterval(tagSelectCountdown,1000);\r\n\t\t\ttagSelectCountdown();\r\n\t\t\ttagselectTimeout = setTimeout(function(){\r\n\t\t\t\t$systags.children().each(function(i,el){\r\n\t\t\t\t\tlet $input = $(el).find('input'),\r\n\t\t\t\t\t\ttag = $input.attr('name');\r\n\t\t\t\t\tif ($input.prop('checked'))\r\n\t\t\t\t\t\ttagArray.push(tag);\r\n\t\t\t\t});\r\n\r\n\t\t\t\tlet tagsCond = tagArray.length > 0,\r\n\t\t\t\t\tval = parseInt($filterID.val(), 10),\r\n\t\t\t\t\tfilterCond = !isNaN(val);\r\n\r\n\t\t\t\tif (tagsCond){\r\n\t\t\t\t\tsettings.allowedTags = tagArray;\r\n\t\t\t\t\tLStorage.set('setting_allowed_tags',tagArray.join(','));\r\n\t\t\t\t}\r\n\t\t\t\tif (filterCond){\r\n\t\t\t\t\tsettings.filterID = val;\r\n\t\t\t\t\tLStorage.set('setting_filterid',settings.filterID);\r\n\t\t\t\t}\r\n\t\t\t\telse {\r\n\t\t\t\t\t$usefilterInput.prop('checked', false);\r\n\t\t\t\t\tsettings.filterID = undefined;\r\n\t\t\t\t\tLStorage.del('setting_filterid');\r\n\t\t\t\t}\r\n\t\t\t\tif (tagsCond || filterCond){\r\n\t\t\t\t\t$image.css('opacity','0');\r\n\t\t\t\t\t$imageGhost.css('opacity','0');\r\n\t\t\t\t\tunbindHandlers();\r\n\r\n\t\t\t\t\tsetTimeout(reQuest,300);\r\n\t\t\t\t}\r\n\t\t\t}, 5000);\r\n\t\t}\r\n\t\t$settings.find('.systags label span').on('click',function(e){\r\n\t\t\te.preventDefault();\r\n\r\n\t\t\tlet $thisInput = $(this).prev();\r\n\t\t\t$thisInput.prop('checked',!$thisInput.prop('checked'));\r\n\r\n\t\t\ttagSelectCountdownStarter();\r\n\t\t});\r\n\r\n\t\tif (LStorage.has('setting_filterid')){\r\n\t\t\tlet filterid = parseInt(LStorage.get('setting_filterid'), 10);\r\n\t\t\tif (isNaN(filterid))\r\n\t\t\t\tLStorage.del('setting_filterid');\r\n\t\t\telse {\r\n\t\t\t\tsettings.filterID = filterid;\r\n\t\t\t\t$usefilterInput.prop('checked', true);\r\n\t\t\t\t$filterID.val(settings.filterID).trigger('change');\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (settings.allowedTags.length === 0){\r\n\t\t\tLStorage.set('setting_allowed_tags','safe');\r\n\t\t\tsettings.allowedTags = ['safe'];\r\n\t\t}\r\n\t\t$usefilterInput.on('click',function(){\r\n\t\t\tlet $this = $(this),\r\n\t\t\t\tchecked = $this.prop('checked');\r\n\r\n\t\t\tif (!checked)\r\n\t\t\t\t$filterID.val('').trigger('change');\r\n\t\t});\r\n\t\t$filterIDSelect.on('change keyup',function(){\r\n\t\t\tlet val = $filterIDSelect.val();\r\n\t\t\tif (val && /^\\d+$/.test(val)){\r\n\t\t\t\tif ($usefilterInput.prop('checked') !== true)\r\n\t\t\t\t\t$usefilterInput.prop('checked', true);\r\n\t\t\t\t$filterID.val(val).trigger('change');\r\n\t\t\t}\r\n\t\t});\r\n\t\t$filterID.on('change keyup',function(){\r\n\t\t\tif ($filterIDSelect.find('option[value=\"'+$filterID.val()+'\"]').length)\r\n\t\t\t\t$filterIDSelect.val($filterID.val());\r\n\t\t\telse $filterIDSelect.val('???');\r\n\t\t\tif (!$filterID.is(':valid'))\r\n\t\t\t\treturn;\r\n\r\n\t\t\tlet currFilter = settings.filterID ? settings.filterID : '';\r\n\t\t\tif ($filterID.val() !== currFilter)\r\n\t\t\t\ttagSelectCountdownStarter();\r\n\t\t});\r\n\t})();\r\n\t// Metadata settings\r\n\t(function MatadataSettings(){\r\n\t\tlet $inputs = $metaSettings.find('.switch input'), keys;\r\n\t\t$inputs.each(function(){\r\n\t\t\tsettings.metadata[this.name] = false;\r\n\t\t});\r\n\t\t\r\n\t\tif (!LStorage.has('setting_metadata')){\r\n\t\t\tkeys = Object.keys(settings.metadata);\r\n\t\t\tLStorage.set('setting_metadata',keys.join(','));\r\n\t\t}\r\n\t\telse {\r\n\t\t\tkeys = LStorage.get('setting_metadata');\r\n\t\t\tif (keys.length === 0) keys = [];\r\n\t\t\telse keys = keys.split(',');\r\n\t\t}\r\n\t\t\r\n\t\t$.each(keys,function(i,el){\r\n\t\t\tif (typeof settings.metadata[el] !== 'undefined')\r\n\t\t\t\tsettings.metadata[el] = true;\r\n\t\t\telse delete keys[i];\r\n\t\t});\r\n\t\t\r\n\t\tfunction updateMetadataSettings(noupdatekeys){\r\n\t\t\tif (noupdatekeys !== true) LStorage.set('setting_metadata',keys.join(','));\r\n\t\t\t\r\n\t\t\t$inputs.each(function(){\r\n\t\t\t\t$('#data .'+this.name.substring(4))[keys.indexOf(this.name) > -1?'show':'hide']();\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\t$data.find('p span').filter(':visible').addClass('visible').last().removeClass('visible');\r\n\t\t}\r\n\t\twindow.updateMetadataSettings = function(){ updateMetadataSettings() };\r\n\t\t\r\n\t\tupdateMetadataSettings();\r\n\t\t\r\n\t\t$inputs.each(function(){\r\n\t\t\tthis.checked = !!settings.metadata[this.name];\r\n\t\t\t$(this).prop('checked',this.checked);\r\n\t\t});\r\n\t\t$metaSettings.find('.switch input').on('click',function(e){\r\n\t\t\te.stopPropagation();\r\n\t\t\t\r\n\t\t\tlet nameAttr = this.name,\r\n\t\t\t\tattrIndx = keys.indexOf(nameAttr);\r\n\t\t\t\r\n\t\t\tif (attrIndx === -1) keys.push(nameAttr);\r\n\t\t\telse keys.splice(attrIndx, 1);\r\n\t\t\t\r\n\t\t\tupdateMetadataSettings();\r\n\t\t});\r\n\t})();\r\n\t// Image cropping settings\r\n\t(function ImageCroppingSettings(){\r\n\t\tlet $select = $cropSettings.find('.input-field select');\r\n\r\n\t\tif (!LStorage.has('setting_crop')){\r\n\t\t\tsettings.crop = 'contain';\r\n\t\t\tLStorage.set('setting_crop', settings.crop);\r\n\t\t}\r\n\t\telse settings.crop = LStorage.get('setting_crop');\r\n\r\n\t\tfunction updateCroppingSettings(){\r\n\t\t\tlet setTo = settings.crop;\r\n\t\t\tif (['contain','cover','100% 100%'].indexOf(setTo) === -1)\r\n\t\t\t\tsetTo = 'cover';\r\n\r\n\t\t\tLStorage.set('setting_crop', setTo);\r\n\t\t\tsettings.crop = setTo;\r\n\t\t\t$select.val(setTo);\r\n\t\t\tsetBackgroundStyles();\r\n\t\t}\r\n\t\twindow.updateCroppingSettings = function(){ updateCroppingSettings() };\r\n\r\n\t\tupdateCroppingSettings();\r\n\r\n\t\t$select.on('change',function(){\r\n\t\t\tsettings.crop = $select.val();\r\n\r\n\t\t\tupdateCroppingSettings();\r\n\t\t});\r\n\t})();\r\n\r\n\t// Background size updater\r\n\tfunction setBackgroundStyles(image_url){\r\n\t\tif (typeof image_url === 'string')\r\n\t\t\t_currentImageURL = image_url;\r\n\t\telse if (typeof _currentImageURL !== 'string')\r\n\t\t\treturn;\r\n\t\tlet url = _currentImageURL.replace(/\"/g, '%22'),\r\n\t\t\tstyles = '#image{background-image:url(\"'+url+'\");background-size:'+settings.crop+'}';\r\n\t\tif (settings.crop === 'contain'){\r\n\t\t\t$imageGhost.css('opacity','');\r\n\t\t\tstyles += '#image-ghost{display:block;background-image:url(\"'+url+'\")}';\r\n\t\t}\r\n\r\n\t\t$style.html(styles);\r\n\t}\r\n\r\n\t// Begin site\r\n\tif (LStorage.has(\"image_data\") && LStorage.has(\"image_hash\")){\r\n\t\tsetBackgroundStyles(LStorage.get(\"image_data\"));\r\n\t\t$image.css('opacity','1').attr('data-hash',LStorage.get('image_hash'));\r\n\t}\r\n\r\n\treQuest();\r\n\r\n\t$data.html('<h1>Requesting metadata...</h1>').css('opacity', 1);\r\n\tfunction reQuest(page){\r\n\t\t$body.removeClass('notloading');\r\n\t\t$tagSettings.find('.re-request:visible').slideUp();\r\n\t\t\r\n\t\t$.ajax({\r\n\t\t\turl: 'https://trixiebooru.org/search.json'+\r\n\t\t\t        '?filter_id='+(settings.filterID||everythingFilterID)+\r\n\t\t\t        '&q=wallpaper+%26%26+('+settings.allowedTags.join('+%7C%7C+')+')+%26%26+-equestria+girls'+\r\n\t\t\t        (typeof page === 'number' ? '&page='+page : ''),\r\n\t\t\tsuccess: function(data){\r\n\t\t\t\tlet image, imgElement = new Image(), i = -1;\r\n\t\t\t\t\r\n\t\t\t\tdata = data.search;\r\n\t\t\t\t\r\n\t\t\t\tif (data.length === 0) {\r\n\t\t\t\t\tfadeIt();\r\n\t\t\t\t\t$body.addClass('notloading');\r\n\t\t\t\t\t$data.html('<h1>Search returned no results.</h1>' + (settings.allowedTags.indexOf('safe') === -1 ? '<p>Try enabling the safe system tag.</p>' : ''));\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\twhile (++i < data.length-1){\r\n\t\t\t\t\t// Optimal size images are above 720p and below 4096px in width & height, since larger images will make the browser lag\r\n\t\t\t\t\tif (data[i].width >= 1280 && data[i].height >= 720 && data[i].width <= 4096 && data[i].height <= 4096){\r\n\t\t\t\t\t\timage = data[i];\r\n\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\t$body.addClass('notloading');\r\n\t\t\t\t\r\n\t\t\t\tif (typeof image === 'undefined')\r\n\t\t\t\t\treturn reQuest(typeof page === 'number' ? page+1 : 2);\r\n\t\t\t\t\r\n\t\t\t\tif (!LStorage.has(\"image_hash\") || LStorage.get(\"image_hash\") !== image.sha512_hash){\r\n\t\t\t\t\tif (typeof page === 'undefined')\r\n\t\t\t\t\t\t$data.html('<h1>Searching for new image...</h1>').css('opacity','1');\r\n\t\t\t\t\t\r\n\t\t\t\t\timgElement.src = 'http://'+image.image;\r\n\t\t\t\t\t$(imgElement).on('load',function(){\r\n\t\t\t\t\t\t// Save image into localStorage\r\n\t\t\t\t\t\tLStorage.set(\"image_data\", imgElement.src);\r\n\t\t\t\t\t\tLStorage.set(\"image_hash\", image.sha512_hash);\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tmetadata(image, imgElement.src);\r\n\t\t\t\t\t}).on('error', function(){\r\n\t\t\t\t\t\t$data.html('<h1>Image has not been rendered yet</h1><p>Try reloading in a minute or so</p>');\r\n\t\t\t\t\t\tfadeIt();\r\n\t\t\t\t\t\treturn reQuest(typeof page === 'number' ? page+1 : 2);\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t\telse metadata(image, getCachedIMGURL());\r\n\t\t\t},\r\n\t\t\terror: function(){\r\n\t\t\t\t$body.addClass('notloading');\r\n\t\t\t\t$data.html('<h1>There was an error while fetching the image data</h1><p>'+(navigator.onLine ? 'Derpibooru may be down for maintenance, try again later.' : 'You are not conected to the Internet.')+'</p>');\r\n\t\t\t}\r\n\t\t});\r\n\t\t\r\n\t\tfunction metadata(image,cachedurl){\r\n\t\t\tlet tags = image.tags.split(', '),\r\n\t\t\t\tartists = [];\r\n\t\t\t\r\n\t\t\t$.each(tags,function(i,el){\r\n\t\t\t\tif (el.indexOf('artist:') === 0)\r\n\t\t\t\t\tartists.push(el.substring(7));\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tlet artistText = artists.length ? 'By '+textify(artists) : 'Artist unknown';\r\n\t\t\t\r\n\t\t\t$data.empty().append('<h1><a href=\"https://derpibooru.org/'+image.id+'\">'+artistText+'</a></h1>');\r\n\r\n\t\t\t$data.children('h1').simplemarquee({\r\n\t\t\t    speed: 25,\r\n\t\t\t    cycles: Infinity,\r\n\t\t\t    space: 25,\r\n\t\t\t    handleHover: false,\r\n\t\t\t    delayBetweenCycles: 0,\r\n\t\t\t});\r\n\t\t\t\r\n\t\t\tlet votestr = '', cc = image.comment_count;\r\n\t\t\tif (image.upvotes + image.downvotes === 0) votestr = 'no votes';\r\n\t\t\telse {\r\n\t\t\t\tif (image.upvotes > 0){\r\n\t\t\t\t\tvotestr += image.upvotes+' upvote';\r\n\t\t\t\t\tif (image.upvotes > 1) votestr += 's';\r\n\t\t\t\t\tif (image.downvotes > 0){\r\n\t\t\t\t\t\tvotestr += ' and '+image.downvotes+' downvote';\r\n\t\t\t\t\t\tif (image.downvotes > 1) votestr += 's';\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse if (image.downvotes > 0) votestr += image.downvotes+' downvote'+(image.downvotes>1?'s':'');\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t$data.append(\r\n\t\t\t\t`<p>\r\n\t\t\t\t\t<span class=\"uploadtime visible\">uploaded <time datetime=\"${image.created_at}\"></time> by ${image.uploader}</span>\r\n\t\t\t\t\t<span class=\"votes\">${votestr}</span>\r\n\t\t\t\t\t<span class=\"comments\">${cc>0?cc:'no'} comment${cc!==1?'s':''}</span>\r\n\t\t\t\t</p>`\r\n\t\t\t);\r\n\t\t\tupdateMetadataSettings();\r\n\t\t\twindow.updateTimesF();\r\n\r\n\t\t\tsetBackgroundStyles(cachedurl);\r\n\t\t\tfadeIt();\r\n\t\t\tfadeOutData();\r\n\t\t}\r\n\t\t\r\n\t\tlet movetimeout = false,\r\n\t\t\thideFunction = function(){\r\n\t\t\t\tif (!$fadeLayer.children('.hover').length)\r\n\t\t\t\t\t$fadeLayer.css('opacity', 0);\r\n\t\t\t\telse movetimeout = setTimeout(hideFunction, 2000);\r\n\t\t\t};\r\n\t\tfunction fadeIt(){\r\n\t\t\t$image.css('opacity', 1);\r\n\r\n\t\t\t$body.on('mousemove',$.throttle(100,function(){\r\n\t\t\t\tif (document.getElementById('dialog'))\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t$fadeLayer.css('opacity','1');\r\n\t\t\t\t$fadeLayer.on('mouseenter','> *',function(){\r\n\t\t\t\t\t$(this).addClass('hover');\r\n\t\t\t\t}).on('mouseleave','> *',function(){\r\n\t\t\t\t\t$(this).removeClass('hover');\r\n\t\t\t\t});\r\n\t\t\t\tfadeOutData();\r\n\t\t\t}));\r\n\t\t\t$body.triggerHandler('mousemove');\r\n\t\t\t$showSettingsButton.attr('disabled', false).on('click',function(e){\r\n\t\t\t\te.preventDefault();\r\n\r\n\t\t\t\t$settingsWrap.toggleClass('open');\r\n\t\t\t\t$body.triggerHandler('mousemove');\r\n\t\t\t});\r\n\t\t}\r\n\t\t\r\n\t\tfunction fadeOutData(){\r\n\t\t\tif (movetimeout !== false){\r\n\t\t\t\tclearTimeout(movetimeout);\r\n\t\t\t\t//noinspection JSUnusedAssignment\r\n\t\t\t\tmovetimeout = false;\r\n\t\t\t}\r\n\t\t\tif (!$settingsWrap.hasClass('open'))\r\n\t\t\t\tmovetimeout = setTimeout(hideFunction, 2000);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction unbindHandlers(){\r\n\t\t$body.off('mousemove');\r\n\t\t$showSettingsButton.off('click').attr('disabled', true);\r\n\t\t$settingsWrap.removeClass('open');\r\n\t}\r\n\t\r\n\tfunction getCachedIMGURL(){\r\n\t\treturn LStorage.get(\"image_data\");\r\n\t}\r\n\r\n\t// First run dialog\r\n\tif (!LStorage.has('firstrun')){\r\n\t\t$(document.createElement('div'))\r\n\t\t\t.attr('id','dialog')\r\n\t\t\t.html('<div id=\"dialog-inner\"><h1>Welcome to Derpi-New Tab</h1><p>To access the settings click the <i class=\"material-icons\">menu</i> icon in the bottom left of the browser window.<br><span style=\"color:rgba(255,255,255,.5)\">(this message is only displayed once)</span></p></div>')\r\n\t\t\t.children()\r\n\t\t\t.append($(document.createElement('button')).text('Got it').on('click',function(e){\r\n\t\t\t\te.preventDefault();\r\n\r\n\t\t\t\tLStorage.set('firstrun',1);\r\n\t\t\t\tlet $dialog = $('#dialog').addClass('gtfo');\r\n\t\t\t\tsetTimeout(function(){\r\n\t\t\t\t\t$dialog.remove();\r\n\t\t\t\t}, 550);\r\n\t\t\t}))\r\n\t\t\t.end()\r\n\t\t\t.prependTo($body);\r\n\t}\r\n\r\n    $cropSettings.find('select').material_select();\r\n\t\t\r\n\t// List textifier\r\n\tfunction textify(list, append, separator){\r\n\t\tif (typeof append === 'undefined') append = 'and';\r\n\t\tif (typeof separator === 'undefined') separator = ',';\r\n\r\n\t\tlet list_str;\r\n\t\t\r\n\t\tif (typeof list === 'string') list = list.split(separator);\r\n\t\tif (list.length > 1){\r\n\t\t\tlist_str = list;\r\n\t\t\tlet list_str_len = list_str.length,\r\n\t\t\t\tmaxDest = list_str_len-3,\r\n\t\t\t\ti = 0;\r\n\t\t\tlist_str.splice(list_str_len-1,0,append);\r\n\t\t\twhile (i <= maxDest){\r\n\t\t\t\tif (i === list_str_len-1)\r\n\t\t\t\t\tcontinue;\r\n\t\t\t\tlist_str[i] += ',';\r\n\t\t\t\ti++;\r\n\t\t\t}\r\n\t\t\tlist_str = list_str.join(' ');\r\n\t\t}\r\n\t\telse list_str = list[0];\r\n\t\treturn list_str;\r\n\t}\r\n});\r\n"]}